name: Deploy Backend to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Spring Boot App to Windows Server
    runs-on: self-hosted
    environment: production
    
    steps:
      - name: Verificar ruta del proyecto
        run: |
          if (-Not (Test-Path C:\Projects\domain-layer)) {
            Write-Host "Error: La ruta no existe" -ForegroundColor Red
            exit 1
          }
          Write-Host "Ruta del proyecto verificada" -ForegroundColor Green
        shell: powershell

      - name: Pull latest changes
        run: |
          cd C:\Projects\domain-layer
          Write-Host "Verificando remoto configurado:" -ForegroundColor Cyan
          git remote -v
          Write-Host "" 
          Write-Host "Commit ANTES del pull:" -ForegroundColor Yellow
          git log --oneline -1
          Write-Host ""
          Write-Host "Descargando cambios desde GitHub..." -ForegroundColor Cyan
          git fetch --all --prune
          git reset --hard origin/main
          git clean -fd
          Write-Host ""
          Write-Host "Commit DESPUES del pull:" -ForegroundColor Green
          git log --oneline -1
          Write-Host ""
          Write-Host "Verificando archivos corregidos:" -ForegroundColor Cyan
          git show HEAD:src/main/java/com/api/red/negocios/Repositorios/IngresoRepositorio.java | Select-String -Pattern "Agregado diario" -Context 0,2
        shell: powershell

      - name: Ejecutar build
        run: |
          cd C:\Projects\domain-layer
          Write-Host "Compilando proyecto..." -ForegroundColor Cyan
          $javaExe = Get-Command java -ErrorAction Stop
          $env:JAVA_HOME = $javaExe.Source -replace '\\bin\\java.exe$', ''
          Write-Host "JAVA_HOME configurado: $env:JAVA_HOME" -ForegroundColor Green
          cmd /c "mvnw.cmd clean package -DskipTests"
          if ($LASTEXITCODE -ne 0) { exit 1 }
          Write-Host "Compilacion exitosa" -ForegroundColor Green
        shell: powershell

      - name: Reiniciar aplicaci√≥n
        run: |
          cd C:\Projects\domain-layer
          Write-Host "Deteniendo aplicacion anterior..." -ForegroundColor Yellow
          Stop-Process -Name "java" -Force -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 3
          Write-Host "Iniciando nueva version..." -ForegroundColor Cyan
          $jarFile = Get-ChildItem -Path "target" -Filter "negocios-*.jar" | Select-Object -First 1
          if ($jarFile) {
            New-Item -ItemType Directory -Path "logs" -Force | Out-Null
            Start-Process -FilePath "java" -ArgumentList "-jar", "target\$($jarFile.Name)" -WindowStyle Hidden -RedirectStandardOutput "logs\app.log" -RedirectStandardError "logs\error.log"
            Write-Host "Backend actualizado y ejecutandose" -ForegroundColor Green
            Write-Host "Logs en: logs\app.log" -ForegroundColor White
          } else {
            Write-Host "Error: No se encontro el archivo JAR compilado" -ForegroundColor Red
            exit 1
          }
        shell: powershell

      - name: Resumen del deployment
        run: |
          Write-Host "================================" -ForegroundColor Cyan
          Write-Host "DEPLOYMENT COMPLETADO" -ForegroundColor Green
          Write-Host "================================" -ForegroundColor Cyan
          Write-Host "Proyecto: C:\Projects\domain-layer" -ForegroundColor White
          Write-Host "Ambiente: production" -ForegroundColor White
          Write-Host "Fecha: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor White
          Write-Host "Ejecutado por: ${{ github.actor }}" -ForegroundColor White
          Write-Host "================================" -ForegroundColor Cyan
        shell: powershell
