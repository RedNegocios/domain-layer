name: Deploy Backend to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Spring Boot App to Windows Server
    runs-on: self-hosted
    environment: production
    
    steps:
      - name: Verificar ruta del proyecto
        run: |
          if (-Not (Test-Path "C:\Projects\RedNegociosBackend")) {
            Write-Host "‚ùå Error: La ruta C:\Projects\RedNegociosBackend no existe" -ForegroundColor Red
            exit 1
          }
          Write-Host "‚úÖ Ruta del proyecto verificada: C:\Projects\RedNegociosBackend" -ForegroundColor Green
        shell: powershell

      - name: Configurar Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Pull latest changes
        run: |
          cd "C:\Projects\RedNegociosBackend"
          
          Write-Host "üì• Descargando cambios desde GitHub..." -ForegroundColor Cyan
          git fetch origin
          
          $currentBranch = git rev-parse --abbrev-ref HEAD
          Write-Host "üìç Rama actual: $currentBranch" -ForegroundColor Yellow
          
          git reset --hard origin/main
          
          Write-Host "‚úÖ C√≥digo actualizado desde GitHub" -ForegroundColor Green
          Write-Host "üìù √öltimo commit:" -ForegroundColor Cyan
          git log --oneline -1
          
          Write-Host "`nüìä Estado del repositorio:" -ForegroundColor Cyan
          git status
        shell: powershell

      - name: Ejecutar build
        run: |
          cd "C:\Projects\RedNegociosBackend"
          Write-Host "üî® Compilando proyecto..." -ForegroundColor Cyan
          .\mvnw.cmd clean package -DskipTests
          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ùå Error en la compilaci√≥n" -ForegroundColor Red
            exit 1
          }
          Write-Host "‚úÖ Compilaci√≥n exitosa" -ForegroundColor Green
        shell: powershell

      - name: Reiniciar aplicaci√≥n
        run: |
          cd "C:\Projects\RedNegociosBackend"
          Write-Host "üõë Deteniendo aplicaci√≥n anterior..." -ForegroundColor Yellow
          Stop-Process -Name "java" -Force -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 3
          
          Write-Host "üöÄ Iniciando nueva versi√≥n..." -ForegroundColor Cyan
          $jarFile = Get-ChildItem -Path "target" -Filter "negocios-*.jar" | Select-Object -First 1
          
          if ($jarFile) {
            # Crear carpeta de logs si no existe
            New-Item -ItemType Directory -Path "logs" -Force | Out-Null
            
            Start-Process -FilePath "java" `
                         -ArgumentList "-jar", "target\$($jarFile.Name)" `
                         -WindowStyle Hidden `
                         -RedirectStandardOutput "logs\app.log" `
                         -RedirectStandardError "logs\error.log"
            
            Write-Host "‚úÖ Backend actualizado y ejecut√°ndose" -ForegroundColor Green
            Write-Host "üìù Logs en: logs\app.log" -ForegroundColor White
          } else {
            Write-Host "‚ùå Error: No se encontr√≥ el archivo JAR compilado" -ForegroundColor Red
            exit 1
          }
        shell: powershell

      - name: Resumen del deployment
        run: |
          Write-Host "`n================================" -ForegroundColor Cyan
          Write-Host "   DEPLOYMENT COMPLETADO" -ForegroundColor Green
          Write-Host "================================" -ForegroundColor Cyan
          Write-Host "üìÅ Proyecto: C:\Projects\RedNegociosBackend" -ForegroundColor White
          Write-Host "üåç Ambiente: production" -ForegroundColor White
          Write-Host "‚è∞ Fecha: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor White
          Write-Host "üë§ Ejecutado por: ${{ github.actor }}" -ForegroundColor White
          Write-Host "================================`n" -ForegroundColor Cyan
        shell: powershell
