name: Deploy Backend to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Spring Boot App to Windows Server
    runs-on: self-hosted
    environment: production
    
    steps:
      - name: Verificar ruta del proyecto
        run: |
          if (-Not (Test-Path C:\Projects\domain-layer)) {
            Write-Host "Error: La ruta no existe" -ForegroundColor Red
            exit 1
          }
          Write-Host "Ruta del proyecto verificada" -ForegroundColor Green
        shell: powershell

      - name: Pull latest changes
        run: |
          cd C:\Projects\domain-layer
          Write-Host "Verificando remoto configurado:" -ForegroundColor Cyan
          git remote -v
          Write-Host "" 
          Write-Host "Commit ANTES del pull:" -ForegroundColor Yellow
          git log --oneline -1
          Write-Host ""
          Write-Host "Descargando cambios desde GitHub..." -ForegroundColor Cyan
          git fetch --all --prune
          git reset --hard origin/main
          git clean -fd
          Write-Host ""
          Write-Host "Commit DESPUES del pull:" -ForegroundColor Green
          git log --oneline -1
          Write-Host ""
          Write-Host "Verificando archivos corregidos:" -ForegroundColor Cyan
          git show HEAD:src/main/java/com/api/red/negocios/Repositorios/IngresoRepositorio.java | Select-String -Pattern "Agregado diario" -Context 0,2
        shell: powershell

      - name: Ejecutar build
        run: |
          cd C:\Projects\domain-layer
          Write-Host "Compilando proyecto..." -ForegroundColor Cyan
          
          Write-Host "JAVA_HOME original: $env:JAVA_HOME" -ForegroundColor Yellow
          
          # JAVA_HOME debe apuntar a la raiz de Java (sin \bin) para que mvnw funcione
          $javaHomeBase = $env:JAVA_HOME -replace '\\bin$', ''
          $env:JAVA_HOME = $javaHomeBase
          
          Write-Host "JAVA_HOME corregido: $env:JAVA_HOME" -ForegroundColor Green
          Write-Host "Version de Java:" -ForegroundColor Yellow
          & "$env:JAVA_HOME\bin\java.exe" -version
          
          Write-Host "Ejecutando: mvnw.cmd clean package -DskipTests" -ForegroundColor Yellow
          .\mvnw.cmd clean package -DskipTests
          if ($LASTEXITCODE -ne 0) { exit 1 }
          
          Write-Host "Compilacion exitosa" -ForegroundColor Green
          Write-Host "WAR generado:" -ForegroundColor Cyan
          Get-ChildItem target\*.war | Select-Object Name, Length, LastWriteTime
        shell: powershell

      - name: Desplegar WAR a Tomcat
        run: |
          cd C:\Projects\domain-layer
          $tomcatWebapps = "C:\Projects\servers\red-negocios\tomcat10\apache-tomcat-10.1.34\webapps"
          $warFile = "target\negocios.war"
          
          Write-Host "Copiando WAR a Tomcat..." -ForegroundColor Cyan
          if (Test-Path $warFile) {
            Copy-Item $warFile -Destination "$tomcatWebapps\negocios.war" -Force
            Write-Host "WAR desplegado exitosamente en: $tomcatWebapps" -ForegroundColor Green
          } else {
            Write-Host "Error: No se encontro el archivo WAR en $warFile" -ForegroundColor Red
            exit 1
          }
        shell: powershell

      - name: Reiniciar Tomcat
        run: |
          $tomcatHome = "C:\Projects\servers\red-negocios\tomcat10\apache-tomcat-10.1.34"
          $tomcatBin = "$tomcatHome\bin"
          
          # Configurar CATALINA_HOME para que Tomcat funcione
          $env:CATALINA_HOME = $tomcatHome
          
          Write-Host "Reiniciando Tomcat..." -ForegroundColor Cyan
          Write-Host "CATALINA_HOME: $env:CATALINA_HOME" -ForegroundColor Yellow
          
          Write-Host "Deteniendo procesos de Tomcat..." -ForegroundColor Yellow
          Stop-Process -Name "java" -Force -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 5
          
          Write-Host "Verificando WAR desplegado:" -ForegroundColor Cyan
          if (Test-Path "$tomcatHome\webapps\negocios.war") {
            $warInfo = Get-Item "$tomcatHome\webapps\negocios.war"
            Write-Host "  WAR encontrado: $($warInfo.Name) ($($warInfo.Length) bytes)" -ForegroundColor Green
          } else {
            Write-Host "  ADVERTENCIA: WAR no encontrado en webapps" -ForegroundColor Yellow
          }
          
          Write-Host "Iniciando Tomcat..." -ForegroundColor Green
          if (Test-Path "$tomcatBin\catalina.bat") {
            # Iniciar Tomcat como proceso independiente que sobrevive al workflow
            $psi = New-Object System.Diagnostics.ProcessStartInfo
            $psi.FileName = "cmd.exe"
            $psi.Arguments = "/c `"cd /d `"$tomcatBin`" && catalina.bat start`""
            $psi.UseShellExecute = $true
            $psi.WindowStyle = [System.Diagnostics.ProcessWindowStyle]::Hidden
            $psi.CreateNoWindow = $false
            $process = [System.Diagnostics.Process]::Start($psi)
            
            Write-Host "Proceso de inicio lanzado" -ForegroundColor Green
            Write-Host "Esperando que Tomcat inicie (15 segundos)..." -ForegroundColor Yellow
            Start-Sleep -Seconds 15
            
            Write-Host "Verificando si Tomcat esta corriendo..." -ForegroundColor Cyan
            $tomcatProcess = Get-Process -Name "java" -ErrorAction SilentlyContinue
            if ($tomcatProcess) {
              Write-Host "Tomcat esta corriendo (PID: $($tomcatProcess.Id))" -ForegroundColor Green
              Write-Host "Aplicacion disponible en: http://localhost:8080/negocios" -ForegroundColor Cyan
            } else {
              Write-Host "ERROR: Tomcat no inicio correctamente" -ForegroundColor Red
              Write-Host "Ultimas lineas del log de Tomcat:" -ForegroundColor Yellow
              Get-Content "$tomcatHome\logs\catalina.*.log" -Tail 30 -ErrorAction SilentlyContinue
              exit 1
            }
          } else {
            Write-Host "Error: No se encontro catalina.bat en $tomcatBin" -ForegroundColor Red
            exit 1
          }
        shell: powershell

      - name: Resumen del deployment
        run: |
          Write-Host "================================" -ForegroundColor Cyan
          Write-Host "DEPLOYMENT COMPLETADO" -ForegroundColor Green
          Write-Host "================================" -ForegroundColor Cyan
          Write-Host "Proyecto: C:\Projects\domain-layer" -ForegroundColor White
          Write-Host "WAR: negocios.war" -ForegroundColor White
          Write-Host "Tomcat: C:\Projects\servers\red-negocios\tomcat10\apache-tomcat-10.1.34" -ForegroundColor White
          Write-Host "URL: http://localhost:8080/negocios" -ForegroundColor White
          Write-Host "Ambiente: production" -ForegroundColor White
          Write-Host "Fecha: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor White
          Write-Host "Ejecutado por: ${{ github.actor }}" -ForegroundColor White
          Write-Host "================================" -ForegroundColor Cyan
        shell: powershell
